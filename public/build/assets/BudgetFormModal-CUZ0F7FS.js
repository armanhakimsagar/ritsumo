import{r as u,j as e}from"./ui-Ps9nvBG1.js";import{K as Y,D as G,l as J,n as W,o as X,e as i,I as p,B as C,P as Z,A as $,f as ee}from"./app-BTt_gkO3.js";import{T as te}from"./textarea-DPiv_-Qc.js";import{S as A,a as z,b as L,c as q,d as b}from"./select-z0EzYxFC.js";import{T as ae}from"./trash-2-WsAE_ige.js";function me({isOpen:D,onClose:B,budget:d,mode:r,currentProject:g}){var k;const{projects:N=[],currencies:se=[],workspace:re}=Y().props,[a,c]=u.useState({project_id:"",total_budget:"",period_type:"project",start_date:"",end_date:"",description:"",status:"active"}),[o,_]=u.useState([]),[de,w]=u.useState([]),[n,h]=u.useState({}),[le,S]=u.useState(!1),[y,F]=u.useState(!1),[v,I]=u.useState(""),P=u.useMemo(()=>v?N.filter(t=>t.title.toLowerCase().includes(v.toLowerCase())).slice(0,50):N.slice(0,50),[N,v]);u.useEffect(()=>{r==="edit"&&d?(c({project_id:d.project_id.toString(),total_budget:d.total_budget.toString(),period_type:d.period_type,start_date:d.start_date,end_date:d.end_date||"",description:d.description||"",status:d.status}),_(d.categories.map(t=>({name:t.name,allocated_amount:t.allocated_amount,color:t.color,description:t.description||""})))):r==="create"&&(E(),g&&c(t=>({...t,project_id:g.id.toString()})),M())},[r,d,D,g]);const E=()=>{c({project_id:"",total_budget:"",period_type:"project",start_date:"",end_date:"",description:"",status:"active"}),_([]),h({}),F(!1),S(!1)},M=async()=>{try{S(!0);const t=await fetch(route("budgets.default-categories"));if(!t.ok){w([]);return}const s=await t.json();w(s.categories||[])}catch{w([])}finally{S(!1)}},O=()=>{if(r==="create"&&!a.project_id){h({project_id:"Please select a project first"});return}if(!a.total_budget||parseFloat(a.total_budget)<=0){h({total_budget:"Please enter total budget amount first"});return}_([...o,{name:"",allocated_amount:0,color:"#3B82F6",description:""}])},f=(t,s,l)=>{const x=[...o];x[t]={...x[t],[s]:l},_(x)},V=t=>{_(o.filter((s,l)=>l!==t))},m=()=>o.reduce((t,s)=>t+(parseFloat(s.allocated_amount.toString())||0),0),R=t=>{t.preventDefault(),h({});const s={};a.project_id||(s.project_id="Please select a project"),(!a.total_budget||parseFloat(a.total_budget)<=0)&&(s.total_budget="Please enter a valid budget amount"),parseFloat(a.total_budget)>99999999999e-2&&(s.total_budget="Budget amount cannot exceed 999,999,999.99"),a.end_date&&a.start_date&&a.end_date<=a.start_date&&(s.end_date="End date must be after start date"),a.end_date&&new Date(a.end_date)<new Date&&(s.end_date="End date cannot be in the past"),o.length===0&&(s.categories="Please add at least one budget category"),o.some(j=>!j.name.trim())&&(s.categories="All categories must have a name");const x=parseFloat(a.total_budget);if(m()>x&&(s.categories="Total allocated amount cannot exceed budget"),Object.keys(s).length>0){h(s);return}const K={...a,total_budget:x,categories:o.map((j,U)=>({...j,allocated_amount:parseFloat(j.allocated_amount.toString())||0,sort_order:U+1}))};F(!0);const Q=r==="create"?route("budgets.store"):route("budgets.update",d==null?void 0:d.id);ee[r==="create"?"post":"put"](Q,K,{onSuccess:()=>{B(),r==="create"&&E()},onError:j=>h(j),onFinish:()=>F(!1)})},H=["#3B82F6","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#6B7280","#84CC16","#F97316","#06B6D4","#DC2626","#059669","#7C3AED","#DB2777","#4F46E5","#0891B2"],T=()=>{y||B()};return e.jsx(G,{open:D,onOpenChange:T,children:e.jsxs(J,{className:"max-w-4xl max-h-[90vh] overflow-y-auto z-50",children:[e.jsx(W,{children:e.jsx(X,{children:r==="create"?"Create Budget":"Edit Budget"})}),e.jsxs("form",{onSubmit:R,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(i,{htmlFor:"project_id",children:"Project *"}),g||r==="edit"?e.jsx(p,{value:(g==null?void 0:g.title)||((k=d==null?void 0:d.project)==null?void 0:k.title)||"",disabled:!0,className:"bg-gray-50"}):e.jsxs(A,{value:a.project_id,onValueChange:t=>c({...a,project_id:t}),disabled:r==="edit",children:[e.jsx(z,{children:e.jsx(L,{placeholder:"Select project"})}),e.jsxs(q,{className:"z-[60]",children:[e.jsx("div",{className:"sticky top-0 bg-white p-2 border-b z-10 backdrop-blur-sm",children:e.jsx(p,{placeholder:"Search projects...",value:v,onChange:t=>I(t.target.value),className:"h-8"})}),P.map(t=>e.jsx(b,{value:t.id.toString(),children:t.title},t.id))]})]}),n.project_id&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.project_id})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"total_budget",children:"Total Budget *"}),e.jsx(p,{id:"total_budget",type:"number",step:"0.01",max:"999999999.99",value:a.total_budget,onChange:t=>c({...a,total_budget:t.target.value}),placeholder:"0.00",required:!0}),n.total_budget&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.total_budget})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"period_type",children:"Period Type *"}),e.jsxs(A,{value:a.period_type,onValueChange:t=>c({...a,period_type:t}),children:[e.jsx(z,{children:e.jsx(L,{placeholder:"Select period type"})}),e.jsxs(q,{className:"z-[60]",children:[e.jsx(b,{value:"project",children:"Project Budget"}),e.jsx(b,{value:"monthly",children:"Monthly Budget"}),e.jsx(b,{value:"quarterly",children:"Quarterly Budget"}),e.jsx(b,{value:"yearly",children:"Yearly Budget"})]})]}),n.period_type&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.period_type})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"start_date",children:"Start Date *"}),e.jsx(p,{id:"start_date",type:r==="edit"?"text":"date",value:r==="edit"?a.start_date?new Date(a.start_date).toLocaleDateString():"Not set":a.start_date,onChange:r==="edit"?void 0:t=>c({...a,start_date:t.target.value}),disabled:r==="edit",className:r==="edit"?"bg-gray-50":"",required:r==="create"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"end_date",children:"End Date"}),e.jsx(p,{id:"end_date",type:r==="edit"?"text":"date",value:r==="edit"?a.end_date?new Date(a.end_date).toLocaleDateString():"Ongoing":a.end_date,onChange:r==="edit"?void 0:t=>c({...a,end_date:t.target.value}),disabled:r==="edit",className:r==="edit"?"bg-gray-50":""}),n.end_date&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.end_date})]})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"description",children:"Description"}),e.jsx(te,{id:"description",value:a.description,onChange:t=>c({...a,description:t.target.value}),placeholder:"Budget description...",rows:3})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(i,{className:"text-base font-medium",children:"Budget Categories *"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(C,{type:"button",variant:"outline",size:"sm",onClick:O,disabled:r==="create"&&!a.project_id||!a.total_budget||parseFloat(a.total_budget)<=0,children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Add Category"]})})]}),o.length===0&&e.jsxs("div",{className:"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"No categories added yet"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Add categories to organize your budget allocation"})]}),e.jsx("div",{className:"space-y-4",children:o.map((t,s)=>e.jsxs("div",{className:"p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(i,{children:"Category Name *"}),e.jsx(p,{value:t.name,onChange:l=>f(s,"name",l.target.value),placeholder:"e.g., Development",required:!0})]}),e.jsxs("div",{children:[e.jsx(i,{children:"Allocated Amount *"}),e.jsx(p,{type:"number",step:"0.01",value:t.allocated_amount,onChange:l=>f(s,"allocated_amount",parseFloat(l.target.value)||0),placeholder:"0.00",required:!0})]}),e.jsxs("div",{children:[e.jsx(i,{children:"Color"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"w-8 h-8 rounded border-2 border-gray-300",style:{backgroundColor:t.color}}),e.jsx("input",{type:"color",value:t.color,onChange:l=>f(s,"color",l.target.value),className:"w-12 h-8 rounded border cursor-pointer"}),e.jsx("div",{className:"grid grid-cols-4 gap-1",children:H.slice(0,8).map(l=>e.jsx("button",{type:"button",className:"w-4 h-4 rounded border hover:scale-110 transition-transform",style:{backgroundColor:l},onClick:()=>f(s,"color",l)},l))})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(C,{type:"button",variant:"outline",size:"sm",onClick:()=>V(s),className:"text-red-600 hover:text-red-700",children:e.jsx(ae,{className:"h-4 w-4"})})})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx(i,{children:"Description"}),e.jsx(p,{value:t.description,onChange:l=>f(s,"description",l.target.value),placeholder:"Category description..."})]})]},s))}),o.length>0&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Total Allocated:"}),e.jsx("span",{className:m()>parseFloat(a.total_budget)?"text-red-600 font-medium":"text-green-600",children:(()=>{var t;return typeof window<"u"&&((t=window.appSettings)!=null&&t.formatCurrency)?window.appSettings.formatCurrency(m(),{showSymbol:!0}):m().toFixed(2)})()})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Total Budget:"}),e.jsx("span",{children:(()=>{var t;return typeof window<"u"&&((t=window.appSettings)!=null&&t.formatCurrency)?window.appSettings.formatCurrency(parseFloat(a.total_budget)||0,{showSymbol:!0}):(parseFloat(a.total_budget)||0).toFixed(2)})()})]}),e.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[e.jsx("span",{children:"Remaining:"}),e.jsx("span",{className:parseFloat(a.total_budget)-m()<0?"text-red-600":"text-green-600",children:(()=>{var t;return typeof window<"u"&&((t=window.appSettings)!=null&&t.formatCurrency)?window.appSettings.formatCurrency((parseFloat(a.total_budget)||0)-m(),{showSymbol:!0}):((parseFloat(a.total_budget)||0)-m()).toFixed(2)})()})]})]}),n.categories&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.categories})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(C,{type:"button",variant:"outline",onClick:T,disabled:y,children:"Cancel"}),e.jsx(C,{type:"submit",disabled:o.length===0||!a.project_id||!a.total_budget||y,children:y?"Saving...":r==="create"?"Create Budget":"Update Budget"})]})]})]})})}export{me as B};
