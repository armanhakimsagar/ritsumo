import{r as n,j as e}from"./ui-Ps9nvBG1.js";import{u as He,m as ge,E as u,D as Ge,l as Ke,n as Je,o as Qe,e as m,I as fe,g as _e,B as j,f as N,M as Xe,F as Ye,G as Ze}from"./app-BTt_gkO3.js";import{T as v}from"./textarea-DPiv_-Qc.js";import{S as y,a as w,b as S,c as C,d as c}from"./select-z0EzYxFC.js";import{T as et,a as tt,b as A,c as T}from"./tabs-D83PhGuv.js";import{C as I}from"./CrudDeleteModal-CAwcbZOF.js";import{D as st,a as at,b as rt,c as Ne}from"./dropdown-menu-CvJwe1WI.js";import{B as it}from"./bug-DP5pb0Nw.js";import{S as lt}from"./square-pen-BE6Ef4zh.js";import{T as ye}from"./trash-2-WsAE_ige.js";import{M as we}from"./message-square-DGoN5Yg5.js";import{S as nt}from"./send-B0OsKa7V.js";import{E as ot}from"./ellipsis-DhhTm3i6.js";import{D as ct}from"./download-FY3rJJBK.js";import{P as Se}from"./paperclip-h_SfHoPk.js";import{F as dt}from"./file-3AWHN2l6.js";import"./vendor-B1hewrmX.js";/* empty css            *//* empty css                  */import"./utils-DVuJ_tgg.js";import"./index-C9qibMqK.js";import"./chevron-up-CaRG6751.js";function Ot({bug:s,projects:P,statuses:mt,members:ht,onClose:g,permissions:Ce}){var K,J,Q,X,Y,Z,ee,te,se,ae;const{t:f}=He(),[x,De]=n.useState(Ce),[Me,Ee]=n.useState("details"),[Be,F]=n.useState(!1),[be,k]=n.useState([]),[Fe,z]=n.useState([]),[L,$]=n.useState(!1),[r,p]=n.useState(s),[ke,R]=n.useState(!1),[ze,O]=n.useState(null),[V,U]=n.useState(""),[W,D]=n.useState(null),[Le,M]=n.useState(!1),[_,E]=n.useState(null),[Oe,B]=n.useState(!1),[Ae,q]=n.useState(""),{data:a,setData:o,post:Te,put:Ie,processing:H,errors:i}=ge({project_id:((K=s==null?void 0:s.project_id)==null?void 0:K.toString())||"",milestone_id:((J=s==null?void 0:s.milestone_id)==null?void 0:J.toString())||"none",title:(s==null?void 0:s.title)||"",description:(s==null?void 0:s.description)||"",priority:(s==null?void 0:s.priority)||"medium",severity:(s==null?void 0:s.severity)||"major",steps_to_reproduce:(s==null?void 0:s.steps_to_reproduce)||"",expected_behavior:(s==null?void 0:s.expected_behavior)||"",actual_behavior:(s==null?void 0:s.actual_behavior)||"",environment:(s==null?void 0:s.environment)||"",assigned_to:((X=(Q=s==null?void 0:s.assigned_to)==null?void 0:Q.id)==null?void 0:X.toString())||"none",start_date:(s==null?void 0:s.start_date)||"",end_date:(s==null?void 0:s.end_date)||"",resolution_notes:(s==null?void 0:s.resolution_notes)||""}),{data:G,setData:Pe,post:$e,reset:Re}=ge({comment:""});P.find(t=>t.id.toString()===a.project_id),n.useEffect(()=>{a.project_id?($(!0),u.get(route("api.bugs.project-data")+`?project_id=${a.project_id}`).then(t=>{t.data.success&&(k(t.data.members||[]),z(t.data.milestones||[]))}).catch(t=>{console.error("Error fetching project data:",t),k([]),z([])}).finally(()=>{$(!1)})):(k([]),z([]))},[a.project_id]),n.useEffect(()=>{a.project_id&&!s&&o("assigned_to","none")},[a.project_id]),n.useEffect(()=>{s!=null&&s.id?(R(!0),u.get(route("bugs.show",s.id)).then(t=>{p(t.data.bug),De(t.data.permissions)}).catch(t=>{console.error("Error fetching bug data:",t),p(s)}).finally(()=>{R(!1)})):p(s)},[s]);const Ve=t=>{t.preventDefault();const l={...a,milestone_id:a.milestone_id==="none"?null:a.milestone_id,assigned_to:a.assigned_to==="none"?null:a.assigned_to};s?Ie(route("bugs.update",s.id),{onSuccess:()=>g(),onError:h=>{console.error("Update error:",h)}}):(Object.keys(l).forEach(h=>{o(h,l[h])}),Te(route("bugs.store"),{onSuccess:()=>g(),onError:h=>{console.error("Create error:",h)}}))},Ue=t=>{t.preventDefault(),$e(route("bug-comments.store",r.id),{onSuccess:()=>{Re(),r!=null&&r.id&&u.get(route("bugs.show",r.id)).then(l=>{p(l.data.bug)}).catch(l=>{console.error("Error refreshing bug data:",l)})}})},We=t=>{const l={low:"bg-blue-100 text-blue-800",medium:"bg-yellow-100 text-yellow-800",high:"bg-orange-100 text-orange-800",critical:"bg-red-100 text-red-800"};return l[t]||l.medium},qe=t=>{const l={minor:"bg-green-100 text-green-800",major:"bg-yellow-100 text-yellow-800",critical:"bg-orange-100 text-orange-800",blocker:"bg-red-100 text-red-800"};return l[t]||l.major};return e.jsxs(Ge,{open:!0,onOpenChange:g,children:[e.jsxs(Ke,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Je,{children:e.jsxs(Qe,{className:"flex items-center gap-2",children:[e.jsx(it,{className:"h-5 w-5 text-red-500"}),s?`${f("Edit Bug")}: ${s.title}`:f("Report New Bug")]})}),e.jsxs(et,{value:Me,onValueChange:Ee,children:[e.jsxs(tt,{className:"grid w-full grid-cols-3",children:[e.jsx(A,{value:"details",children:f("Details")}),e.jsxs(A,{value:"comments",disabled:!r,children:[f("Comments")," ",(Y=r==null?void 0:r.comments)!=null&&Y.length?`(${r.comments.length})`:""]}),e.jsxs(A,{value:"attachments",disabled:!r,children:[f("Attachments")," ",(Z=r==null?void 0:r.attachments)!=null&&Z.length?`(${r.attachments.length})`:""]})]}),e.jsx(T,{value:"details",className:"space-y-4",children:e.jsxs("form",{onSubmit:Ve,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"project_id",children:"Project *"}),e.jsxs(y,{value:a.project_id,onValueChange:t=>o("project_id",t),children:[e.jsx(w,{children:e.jsx(S,{placeholder:"Select project"})}),e.jsx(C,{className:"z-[9999]",children:P.map(t=>e.jsx(c,{value:t.id.toString(),children:t.title},t.id))})]}),i.project_id&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.project_id})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"milestone_id",children:"Milestone"}),e.jsxs(y,{value:a.milestone_id,onValueChange:t=>o("milestone_id",t),children:[e.jsx(w,{children:e.jsx(S,{placeholder:L?"Loading...":"Select milestone"})}),e.jsxs(C,{className:"z-[9999]",children:[e.jsx(c,{value:"none",children:"No milestone"}),Fe.map(t=>e.jsx(c,{value:t.id.toString(),children:t.title},t.id))]})]}),i.milestone_id&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.milestone_id})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"title",children:"Bug Title *"}),e.jsx(fe,{id:"title",value:a.title,onChange:t=>o("title",t.target.value),placeholder:"Brief description of the bug",required:!0}),i.title&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.title})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"description",children:"Description"}),e.jsx(v,{id:"description",value:a.description,onChange:t=>o("description",t.target.value),placeholder:"Detailed description of the bug",rows:3}),i.description&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.description})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"priority",children:"Priority *"}),e.jsxs(y,{value:a.priority,onValueChange:t=>o("priority",t),children:[e.jsx(w,{children:e.jsx(S,{})}),e.jsxs(C,{className:"z-[9999]",children:[e.jsx(c,{value:"low",children:"Low"}),e.jsx(c,{value:"medium",children:"Medium"}),e.jsx(c,{value:"high",children:"High"}),e.jsx(c,{value:"critical",children:"Critical"})]})]}),i.priority&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.priority})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"severity",children:"Severity *"}),e.jsxs(y,{value:a.severity,onValueChange:t=>o("severity",t),children:[e.jsx(w,{children:e.jsx(S,{})}),e.jsxs(C,{className:"z-[9999]",children:[e.jsx(c,{value:"minor",children:"Minor"}),e.jsx(c,{value:"major",children:"Major"}),e.jsx(c,{value:"critical",children:"Critical"}),e.jsx(c,{value:"blocker",children:"Blocker"})]})]}),i.severity&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.severity})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"steps_to_reproduce",children:"Steps to Reproduce"}),e.jsx(v,{id:"steps_to_reproduce",value:a.steps_to_reproduce,onChange:t=>o("steps_to_reproduce",t.target.value),placeholder:`1. Step one
2. Step two
3. Step three`,rows:4}),i.steps_to_reproduce&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.steps_to_reproduce})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"expected_behavior",children:"Expected Behavior"}),e.jsx(v,{id:"expected_behavior",value:a.expected_behavior,onChange:t=>o("expected_behavior",t.target.value),placeholder:"What should happen",rows:3}),i.expected_behavior&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.expected_behavior})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"actual_behavior",children:"Actual Behavior"}),e.jsx(v,{id:"actual_behavior",value:a.actual_behavior,onChange:t=>o("actual_behavior",t.target.value),placeholder:"What actually happens",rows:3}),i.actual_behavior&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.actual_behavior})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"environment",children:"Environment"}),e.jsx(fe,{id:"environment",value:a.environment,onChange:t=>o("environment",t.target.value),placeholder:"Browser, OS, device details"}),i.environment&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.environment})]}),(x==null?void 0:x.assign_users)&&e.jsxs("div",{children:[e.jsx(m,{htmlFor:"assigned_to",children:"Assign To"}),e.jsxs(y,{value:a.assigned_to,onValueChange:t=>o("assigned_to",t),disabled:!a.project_id||L,children:[e.jsx(w,{children:e.jsx(S,{placeholder:a.project_id?L?"Loading...":"Select assignee":"Select project first"})}),e.jsxs(C,{className:"z-[9999]",children:[e.jsx(c,{value:"none",children:"Unassigned"}),be.map(t=>e.jsx(c,{value:t.id.toString(),children:t.name},t.id))]})]}),i.assigned_to&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.assigned_to}),!a.project_id&&!i.assigned_to&&e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Please select a project first to see available assignees"})]}),Object.keys(i).length>0&&e.jsx("div",{className:"rounded-md bg-red-50 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:Object.entries(i).map(([t,l])=>e.jsx("p",{children:l},t))})]})]})}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsx("div",{children:s&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_e,{className:We(a.priority),variant:"secondary",children:a.priority}),e.jsx(_e,{className:qe(a.severity),variant:"secondary",children:a.severity})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"button",variant:"outline",onClick:g,children:"Cancel"}),(s?x==null?void 0:x.update:x==null?void 0:x.create)&&e.jsx(j,{type:"submit",disabled:H||!a.project_id||!a.title,children:H?"Saving...":s?"Update Bug":"Report Bug"})]})]})]})}),e.jsx(T,{value:"comments",className:"space-y-4",children:r?e.jsx(e.Fragment,{children:ke?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Loading comments..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:((ee=r.comments)==null?void 0:ee.length)>0?r.comments.map(t=>e.jsxs("div",{className:"group flex gap-3 p-3 hover:bg-gray-50 rounded-lg transition-colors",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-blue-600 font-semibold text-sm",children:t.user.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm text-gray-900",children:t.user.name}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date(t.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.can_update&&e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>{O(t.id),U(t.comment)},className:"h-7 w-7 p-0 text-gray-400 hover:text-blue-600",children:e.jsx(lt,{className:"h-3 w-3"})}),t.can_delete&&e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>{D(t),M(!0)},className:"h-7 w-7 p-0 text-gray-400 hover:text-red-600",children:e.jsx(ye,{className:"h-3 w-3"})})]})]}),ze===t.id?e.jsxs("div",{className:"space-y-2 mt-2",children:[e.jsx(v,{value:V,onChange:l=>U(l.target.value),rows:2,className:"text-sm"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{size:"sm",onClick:()=>{N.put(route("bug-comments.update",t.id),{comment:V},{onSuccess:()=>{O(null),u.get(route("bugs.show",r.id)).then(l=>p(l.data.bug)).catch(console.error)}})},className:"h-7 px-3 text-xs",children:"Save"}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>O(null),className:"h-7 px-3 text-xs",children:"Cancel"})]})]}):e.jsx("p",{className:"text-sm text-gray-700 mt-1 whitespace-pre-wrap",children:t.comment})]})]},t.id)):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(we,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"No comments yet"})]})}),e.jsxs("form",{onSubmit:Ue,className:"flex gap-2",children:[e.jsx(v,{value:G.comment,onChange:t=>Pe("comment",t.target.value),placeholder:"Add a comment...",rows:2,className:"flex-1"}),e.jsx(j,{type:"submit",disabled:!G.comment.trim(),children:e.jsx(nt,{className:"h-4 w-4"})})]})]})}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(we,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"Save the bug first to add comments"})]})}),e.jsx(T,{value:"attachments",children:r?e.jsxs("div",{className:"space-y-4",children:[((te=r.attachments)==null?void 0:te.length)>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:r.attachments.map(t=>{var ie,le,ne,oe,ce,de,me,he,xe,pe,je,ue;const h=(d=>d!=null&&d.startsWith("image/")?Ye:d!=null&&d.includes("pdf")||d!=null&&d.includes("document")?Ze:dt)(((ie=t.media_item)==null?void 0:ie.mime_type)||""),re=((ne=(le=t.media_item)==null?void 0:le.mime_type)==null?void 0:ne.startsWith("image/"))||((ce=(oe=t.media_item)==null?void 0:oe.name)==null?void 0:ce.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)),b=((de=t.media_item)==null?void 0:de.url)||((me=t.media_item)!=null&&me.path?`/storage/${t.media_item.path}`:null);return e.jsxs("div",{className:"group relative bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg hover:border-gray-300 transition-all duration-200",children:[e.jsxs("div",{className:"aspect-[4/3] bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center relative",children:[re&&b?e.jsx("img",{src:b,alt:((he=t.media_item)==null?void 0:he.name)||"Attachment",className:"w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-200",onError:d=>{var ve;d.currentTarget.style.display="none",(ve=d.currentTarget.nextElementSibling)==null||ve.classList.remove("hidden")},onClick:()=>window.open(b,"_blank")}):null,e.jsx("div",{className:`${re&&b?"hidden":"flex"} items-center justify-center w-full h-full`,children:e.jsx(h,{className:"h-16 w-16 text-gray-400"})})]}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs(st,{children:[e.jsx(at,{asChild:!0,children:e.jsx(j,{variant:"secondary",size:"sm",className:"h-8 w-8 p-0 bg-white/90 hover:bg-white shadow-sm",children:e.jsx(ot,{className:"h-4 w-4"})})}),e.jsxs(rt,{align:"end",className:"z-[9999]",children:[e.jsxs(Ne,{onClick:()=>window.open(route("bug-attachments.download",t.id),"_blank"),children:[e.jsx(ct,{className:"h-4 w-4 mr-2"}),"Download"]}),t.can_delete&&e.jsxs(Ne,{onClick:()=>{E(t),B(!0)},className:"text-red-600",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Remove"]})]})]})}),e.jsxs("div",{className:"p-3 bg-white border-t border-gray-100",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate mb-1",title:(xe=t.media_item)==null?void 0:xe.name,children:(pe=t.media_item)==null?void 0:pe.name}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsx("span",{children:(je=t.media_item)==null?void 0:je.mime_type}),e.jsx("span",{children:(ue=t.media_item)!=null&&ue.size?`${Math.round(t.media_item.size/1024)}KB`:""})]})]})]},t.id)})}),((se=r.attachments)==null?void 0:se.length)===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Se,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"No attachments yet"})]}),e.jsx(Xe,{label:"Add from Media Library",value:Ae,onChange:(t,l)=>{q(t),l&&l.length>0&&N.post(route("bug-attachments.store",r.id),{media_item_ids:l},{onSuccess:()=>{u.get(route("bugs.show",r.id)).then(h=>p(h.data.bug)).catch(console.error),q("")}})},placeholder:"Select from media library...",showPreview:!0})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Se,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"Save the bug first to add attachments"})]})})]})]}),e.jsx(I,{isOpen:Be,onClose:()=>F(!1),onConfirm:()=>{s&&N.delete(route("bugs.destroy",s.id),{onSuccess:()=>{F(!1),g()},onError:()=>{F(!1)}})},itemName:(s==null?void 0:s.title)||"",entityName:"bug"}),e.jsx(I,{isOpen:Le,onClose:()=>{M(!1),D(null)},onConfirm:()=>{W&&N.delete(route("bug-comments.destroy",W.id),{onSuccess:()=>{M(!1),D(null),u.get(route("bugs.show",r.id)).then(t=>p(t.data.bug)).catch(console.error)},onError:()=>{M(!1),D(null)}})},itemName:"comment",entityName:"comment"}),e.jsx(I,{isOpen:Oe,onClose:()=>{B(!1),E(null)},onConfirm:()=>{_&&N.delete(route("bug-attachments.destroy",_.id),{onSuccess:()=>{B(!1),E(null),u.get(route("bugs.show",r.id)).then(t=>p(t.data.bug)).catch(console.error)},onError:()=>{B(!1),E(null)}})},itemName:((ae=_==null?void 0:_.media_item)==null?void 0:ae.name)||"attachment",entityName:"attachment"})]})}export{Ot as BugModal};
